<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AICAMP V22 ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: 'Malgun Gothic', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .step {
            margin: 30px 0;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            background: #f8fafc;
        }
        .step h3 {
            color: #1e40af;
            margin-bottom: 15px;
        }
        .button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .button:hover {
            background: #2563eb;
        }
        .success {
            background: #dcfce7;
            border-color: #22c55e;
            color: #15803d;
        }
        .error {
            background: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
        }
        .loading {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #d97706;
        }
        .result-box {
            margin: 20px 0;
            padding: 20px;
            border-radius: 8px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
        }
        .form-group {
            margin: 15px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: #3b82f6;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ AICAMP V22 ì „ì²´ ì›Œí¬í”Œë¡œìš° ë¬´ì˜¤ë¥˜ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
        <p>ì‹¤ì œ GAS ì›Œí¬í”Œë¡œìš°ì™€ ì—°ë™ëœ ì™„ì „í•œ AI ì—­ëŸ‰ì§„ë‹¨ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</p>

        <!-- Step 1: ì§„ë‹¨ ì‹ ì²­ -->
        <div class="step" id="step1">
            <h3>1ë‹¨ê³„: AI ì—­ëŸ‰ì§„ë‹¨ ì‹ ì²­ (ì‹¤ì œ ë°ì´í„° ìƒì„±)</h3>
            
            <div class="form-group">
                <label for="companyName">íšŒì‚¬ëª…</label>
                <input type="text" id="companyName" value="í…ŒìŠ¤íŠ¸ê¸°ì—…" />
            </div>
            
            <div class="form-group">
                <label for="contactName">ë‹´ë‹¹ìëª…</label>
                <input type="text" id="contactName" value="ê¹€í…ŒìŠ¤íŠ¸" />
            </div>
            
            <div class="form-group">
                <label for="contactEmail">ì´ë©”ì¼</label>
                <input type="email" id="contactEmail" value="test@aicamp.club" />
            </div>
            
            <div class="form-group">
                <label for="contactPhone">ì—°ë½ì²˜</label>
                <input type="text" id="contactPhone" value="010-1234-5678" />
            </div>
            
            <div class="form-group">
                <label for="position">ì§ì±…</label>
                <input type="text" id="position" value="CTO" />
            </div>
            
            <div class="form-group">
                <label for="industry">ì—…ì¢…</label>
                <select id="industry">
                    <option value="IT/ì†Œí”„íŠ¸ì›¨ì–´">IT/ì†Œí”„íŠ¸ì›¨ì–´</option>
                    <option value="ì œì¡°ì—…">ì œì¡°ì—…</option>
                    <option value="ì„œë¹„ìŠ¤ì—…">ì„œë¹„ìŠ¤ì—…</option>
                    <option value="ê¸ˆìœµì—…">ê¸ˆìœµì—…</option>
                    <option value="ìœ í†µ/ì†Œë§¤ì—…">ìœ í†µ/ì†Œë§¤ì—…</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="employeeCount">ì§ì›ìˆ˜</label>
                <select id="employeeCount">
                    <option value="10ëª… ë¯¸ë§Œ">10ëª… ë¯¸ë§Œ</option>
                    <option value="10-50ëª…">10-50ëª…</option>
                    <option value="50-100ëª…">50-100ëª…</option>
                    <option value="100-500ëª…">100-500ëª…</option>
                    <option value="500ëª… ì´ìƒ">500ëª… ì´ìƒ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="location">ì†Œì¬ì§€</label>
                <input type="text" id="location" value="ì„œìš¸íŠ¹ë³„ì‹œ" />
            </div>
            
            <button class="button" onclick="generateTestScores()">45ë¬¸í•­ ì ìˆ˜ ìë™ ìƒì„±</button>
            <button class="button" onclick="submitDiagnosis()">ì§„ë‹¨ ì‹ ì²­ ì œì¶œ</button>
            
            <div id="step1-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- Step 2: ì§„ë‹¨ ê²°ê³¼ ì¡°íšŒ -->
        <div class="step" id="step2">
            <h3>2ë‹¨ê³„: ì§„ë‹¨ ê²°ê³¼ ì¡°íšŒ (ì§„ë‹¨ ID ê¸°ë°˜)</h3>
            
            <div class="form-group">
                <label for="queryDiagnosisId">ì§„ë‹¨ ID</label>
                <input type="text" id="queryDiagnosisId" placeholder="Step 1ì—ì„œ ìƒì„±ëœ ì§„ë‹¨ ID ì…ë ¥" />
            </div>
            
            <button class="button" onclick="queryDiagnosis()">ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ</button>
            
            <div id="step2-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- Step 3: 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„± -->
        <div class="step" id="step3">
            <h3>3ë‹¨ê³„: ë§¥í‚¨ì§€ê¸‰ 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„±</h3>
            
            <button class="button" onclick="generateReport()">24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„±</button>
            <button class="button" onclick="viewReport()" style="background: #22c55e;">ë³´ê³ ì„œ ë³´ê¸°</button>
            
            <div class="progress-bar" id="progress-bar" style="display: none;">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
            
            <div id="step3-result" class="result-box" style="display: none;"></div>
        </div>

        <!-- ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ -->
        <div class="step">
            <h3>ğŸ¯ ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ í…ŒìŠ¤íŠ¸</h3>
            <button class="button" onclick="runFullWorkflow()" style="background: #dc2626; font-size: 16px; padding: 15px 30px;">
                ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰
            </button>
            
            <div id="workflow-progress" style="margin-top: 20px; display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="workflow-progress-fill"></div>
                </div>
                <div id="workflow-status" style="margin-top: 10px; font-weight: 600;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentDiagnosisId = null;
        let generatedReport = null;

        // 45ë¬¸í•­ í…ŒìŠ¤íŠ¸ ì ìˆ˜ ìë™ ìƒì„±
        function generateTestScores() {
            const responses = {};
            
            // ê° ì¹´í…Œê³ ë¦¬ë³„ë¡œ ì ìˆ˜ ìƒì„± (ì‹¤ì œ ì‘ë‹µ í˜•íƒœë¡œ)
            const categories = [
                'businessFoundation', 'currentAI', 'organizationReadiness',
                'technologyInfrastructure', 'dataManagement', 'humanResources'
            ];
            
            // ğŸ”¥ ì‚¬ì‹¤ê¸°ë°˜ 1ì›ì¹™: ì •í™•íˆ 45ë¬¸í•­ ìƒì„±
            for (let i = 1; i <= 45; i++) {
                // 1-5ì  ëœë¤ ì ìˆ˜ ìƒì„± (í˜„ì‹¤ì ì¸ ë¶„í¬)
                const score = Math.floor(Math.random() * 3) + 3; // 3-5ì  ìœ„ì£¼
                responses[`question_${i}`] = score;
            }
            
            console.log('âœ… 45ë¬¸í•­ í…ŒìŠ¤íŠ¸ ì ìˆ˜ ìƒì„±:', responses);
            
            // ì´ì  ê³„ì‚°
            const totalScore = Object.values(responses).reduce((sum, score) => sum + score, 0);
            const percentage = Math.round((totalScore / 225) * 100);
            
            document.getElementById('step1-result').innerHTML = `
                <div class="success">
                    âœ… 45ë¬¸í•­ í…ŒìŠ¤íŠ¸ ì ìˆ˜ ìƒì„± ì™„ë£Œ<br>
                    ì´ì : ${totalScore}/225ì  (${percentage}%)<br>
                    ë¬¸í•­ ìˆ˜: ${Object.keys(responses).length}ê°œ
                </div>
            `;
            document.getElementById('step1-result').style.display = 'block';
            
            // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            window.testResponses = responses;
        }

        // ì§„ë‹¨ ì‹ ì²­ ì œì¶œ
        async function submitDiagnosis() {
            try {
                if (!window.testResponses) {
                    alert('ë¨¼ì € 45ë¬¸í•­ ì ìˆ˜ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const resultDiv = document.getElementById('step1-result');
                resultDiv.className = 'result-box loading';
                resultDiv.innerHTML = 'ğŸ”„ ì§„ë‹¨ ì‹ ì²­ ì²˜ë¦¬ ì¤‘... (GAS V22 ì›Œí¬í”Œë¡œìš° ì‹¤í–‰)';
                resultDiv.style.display = 'block';

                // ì§„ë‹¨ ID ìƒì„±
                const timestamp = Date.now();
                const random = Math.floor(Math.random() * 10000);
                currentDiagnosisId = `DIAG_45Q_AI_${timestamp}_${random}`;

                const formData = {
                    diagnosisId: currentDiagnosisId,
                    companyName: document.getElementById('companyName').value,
                    contactName: document.getElementById('contactName').value,
                    contactEmail: document.getElementById('contactEmail').value,
                    contactPhone: document.getElementById('contactPhone').value,
                    position: document.getElementById('position').value,
                    industry: document.getElementById('industry').value,
                    employeeCount: document.getElementById('employeeCount').value,
                    annualRevenue: '',
                    location: document.getElementById('location').value,
                    responses: window.testResponses,
                    assessmentResponses: window.testResponses,
                    privacyConsent: true
                };

                console.log('ğŸ“ ì§„ë‹¨ ì‹ ì²­ ë°ì´í„°:', formData);

                const response = await fetch('/api/ai-diagnosis', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData),
                    signal: AbortSignal.timeout(120000) // 2ë¶„
                });

                const result = await response.json();

                console.log('ğŸ“Š ì§„ë‹¨ ì‹ ì²­ ì‘ë‹µ:', result);
                
                if (result.success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `
                        âœ… ì§„ë‹¨ ì‹ ì²­ ì„±ê³µ!<br>
                        ì§„ë‹¨ ID: <strong>${result.diagnosisId || result.data?.diagnosisId || currentDiagnosisId}</strong><br>
                        ì´ì : ${result.scores?.total || result.data?.scoreData?.totalScore || 0}ì <br>
                        ë“±ê¸‰: ${result.grade || result.data?.scoreData?.grade || 'N/A'}<br>
                        ì„±ìˆ™ë„: ${result.maturityLevel || result.data?.scoreData?.maturityLevel || 'N/A'}
                    `;
                    
                    // Step 2ì— ì§„ë‹¨ ID ìë™ ì…ë ¥
                    const finalDiagnosisId = result.diagnosisId || result.data?.diagnosisId || currentDiagnosisId;
                    document.getElementById('queryDiagnosisId').value = finalDiagnosisId;
                    currentDiagnosisId = finalDiagnosisId;
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `âŒ ì§„ë‹¨ ì‹ ì²­ ì‹¤íŒ¨: ${result.error}<br>ìƒì„¸: ${result.details || 'N/A'}`;
                    console.error('ì§„ë‹¨ ì‹ ì²­ ì‹¤íŒ¨ ìƒì„¸:', result);
                }

            } catch (error) {
                console.error('ì§„ë‹¨ ì‹ ì²­ ì˜¤ë¥˜:', error);
                const resultDiv = document.getElementById('step1-result');
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `âŒ ì§„ë‹¨ ì‹ ì²­ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ
        async function queryDiagnosis() {
            try {
                const diagnosisId = document.getElementById('queryDiagnosisId').value;
                if (!diagnosisId) {
                    alert('ì§„ë‹¨ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                const resultDiv = document.getElementById('step2-result');
                resultDiv.className = 'result-box loading';
                resultDiv.innerHTML = 'ğŸ”„ ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ ì¤‘... (GAS V22ì—ì„œ ì‹¤ì œ ë°ì´í„° ì¡°íšŒ)';
                resultDiv.style.display = 'block';

                const response = await fetch(`/api/diagnosis-reports/${diagnosisId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(120000) // 2ë¶„
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `
                        âœ… ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ ì„±ê³µ!<br>
                        ì§„ë‹¨ ID: ${result.diagnosisId}<br>
                        ë³´ê³ ì„œ íƒ€ì…: ${result.reportInfo.reportType}<br>
                        í˜ì´ì§€ ìˆ˜: ${result.reportInfo.pages}í˜ì´ì§€<br>
                        ë²„ì „: ${result.reportInfo.version}<br>
                        ì‚¬ì‹¤ê¸°ë°˜: ${result.reportInfo.factBasedSystem ? 'âœ…' : 'âŒ'}<br>
                        ê°€ìƒë°ì´í„°: ${result.reportInfo.isVirtualData ? 'âŒ' : 'âœ…'}
                    `;
                    
                    // ë³´ê³ ì„œ ë°ì´í„° ì €ì¥
                    generatedReport = result.htmlReport;
                    currentDiagnosisId = diagnosisId;
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `âŒ ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ ì‹¤íŒ¨: ${result.error}`;
                }

            } catch (error) {
                console.error('ì§„ë‹¨ ì¡°íšŒ ì˜¤ë¥˜:', error);
                const resultDiv = document.getElementById('step2-result');
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `âŒ ì§„ë‹¨ ì¡°íšŒ ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„±
        async function generateReport() {
            try {
                const diagnosisId = currentDiagnosisId || document.getElementById('queryDiagnosisId').value;
                if (!diagnosisId) {
                    alert('ë¨¼ì € ì§„ë‹¨ ë°ì´í„°ë¥¼ ì¡°íšŒí•´ì£¼ì„¸ìš”.');
                    return;
                }

                const resultDiv = document.getElementById('step3-result');
                resultDiv.className = 'result-box loading';
                resultDiv.innerHTML = 'ğŸ”„ ë§¥í‚¨ì§€ê¸‰ 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„± ì¤‘... (ì•½ 30ì´ˆ ì†Œìš”)';
                resultDiv.style.display = 'block';

                // ì§„í–‰ë¥  í‘œì‹œ
                const progressBar = document.getElementById('progress-bar');
                const progressFill = document.getElementById('progress-fill');
                progressBar.style.display = 'block';
                
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 2;
                    progressFill.style.width = Math.min(progress, 90) + '%';
                }, 500);

                const response = await fetch(`/api/diagnosis-reports/${diagnosisId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    signal: AbortSignal.timeout(120000) // 2ë¶„
                });

                clearInterval(progressInterval);
                progressFill.style.width = '100%';

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.success) {
                    resultDiv.className = 'result-box success';
                    resultDiv.innerHTML = `
                        âœ… ë§¥í‚¨ì§€ê¸‰ 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„± ì„±ê³µ!<br>
                        íŒŒì¼ëª…: ${result.reportInfo.fileName}<br>
                        ì´ì : ${result.reportInfo.totalScore}ì <br>
                        ë“±ê¸‰: ${result.reportInfo.grade}<br>
                        ì„±ìˆ™ë„: ${result.reportInfo.maturityLevel}<br>
                        ì—…ì¢…: ${result.reportInfo.industry}<br>
                        ìƒì„± ì‹œê°„: ${new Date(result.reportInfo.createdAt).toLocaleString('ko-KR')}
                    `;
                    
                    // ë³´ê³ ì„œ ë°ì´í„° ì €ì¥
                    generatedReport = result.htmlReport;
                } else {
                    resultDiv.className = 'result-box error';
                    resultDiv.innerHTML = `âŒ ë³´ê³ ì„œ ìƒì„± ì‹¤íŒ¨: ${result.error}`;
                }

            } catch (error) {
                console.error('ë³´ê³ ì„œ ìƒì„± ì˜¤ë¥˜:', error);
                const resultDiv = document.getElementById('step3-result');
                resultDiv.className = 'result-box error';
                resultDiv.innerHTML = `âŒ ë³´ê³ ì„œ ìƒì„± ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // ë³´ê³ ì„œ ë³´ê¸° (ìƒˆ ì°½ì—ì„œ ì—´ê¸°)
        function viewReport() {
            if (!generatedReport) {
                alert('ë¨¼ì € ë³´ê³ ì„œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                // Blobì„ ì‚¬ìš©í•˜ì—¬ HTML íŒŒì¼ ìƒì„±
                const blob = new Blob([generatedReport], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // ìƒˆ ì°½ì—ì„œ ì—´ê¸°
                const newWindow = window.open(url, '_blank');
                
                // ë©”ëª¨ë¦¬ ì •ë¦¬ (5ì´ˆ í›„)
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 5000);
                
                console.log('âœ… 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒˆ ì°½ì—ì„œ ì—´ê¸° ì„±ê³µ');
                
            } catch (error) {
                console.error('ë³´ê³ ì„œ ì—´ê¸° ì˜¤ë¥˜:', error);
                alert('ë³´ê³ ì„œ ì—´ê¸° ì˜¤ë¥˜: ' + error.message);
            }
        }

        // ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰
        async function runFullWorkflow() {
            try {
                console.log('ğŸš€ ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰ ì‹œì‘');
                
                const progressDiv = document.getElementById('workflow-progress');
                const statusDiv = document.getElementById('workflow-status');
                const progressFill = document.getElementById('workflow-progress-fill');
                
                progressDiv.style.display = 'block';
                
                // Step 1: ì ìˆ˜ ìƒì„±
                statusDiv.innerHTML = '1/4: 45ë¬¸í•­ ì ìˆ˜ ìƒì„± ì¤‘...';
                progressFill.style.width = '25%';
                await new Promise(resolve => setTimeout(resolve, 1000));
                generateTestScores();
                
                // Step 2: ì§„ë‹¨ ì‹ ì²­
                statusDiv.innerHTML = '2/4: ì§„ë‹¨ ì‹ ì²­ ì œì¶œ ì¤‘...';
                progressFill.style.width = '50%';
                await new Promise(resolve => setTimeout(resolve, 2000));
                await submitDiagnosis();
                
                // Step 3: ë°ì´í„° ì¡°íšŒ
                statusDiv.innerHTML = '3/4: ì§„ë‹¨ ë°ì´í„° ì¡°íšŒ ì¤‘...';
                progressFill.style.width = '75%';
                await new Promise(resolve => setTimeout(resolve, 2000));
                await queryDiagnosis();
                
                // Step 4: ë³´ê³ ì„œ ìƒì„±
                statusDiv.innerHTML = '4/4: 24í˜ì´ì§€ ë³´ê³ ì„œ ìƒì„± ì¤‘...';
                progressFill.style.width = '100%';
                await new Promise(resolve => setTimeout(resolve, 3000));
                await generateReport();
                
                statusDiv.innerHTML = 'âœ… ì „ì²´ ì›Œí¬í”Œë¡œìš° ì™„ë£Œ! ë³´ê³ ì„œ ë³´ê¸° ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.';
                
                console.log('âœ… ì „ì²´ ì›Œí¬í”Œë¡œìš° ìë™ ì‹¤í–‰ ì™„ë£Œ');
                
            } catch (error) {
                console.error('ì „ì²´ ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜:', error);
                document.getElementById('workflow-status').innerHTML = `âŒ ì›Œí¬í”Œë¡œìš° ì˜¤ë¥˜: ${error.message}`;
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            console.log('ğŸ¯ AICAMP V22 ì „ì²´ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸ ì‹œìŠ¤í…œ ë¡œë“œ ì™„ë£Œ');
            console.log('ì„œë²„ URL:', window.location.origin);
        });
    </script>
</body>
</html>
