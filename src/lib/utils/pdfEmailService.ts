/**
 * üìß PDF Ïù¥Î©îÏùº Î∞úÏÜ° ÏÑúÎπÑÏä§
 * AI Î¨¥Î£åÏßÑÎã® Í≤∞Í≥ºÎ≥¥Í≥†ÏÑúÎ•º PDFÎ°ú ÏÉùÏÑ±Ìï¥ÏÑú Ïù¥Î©îÏùºÎ°ú Î∞úÏÜ°ÌïòÎäî ÌÜµÌï© ÏÑúÎπÑÏä§
 * 
 * ‚úÖ Ï£ºÏöî Í∏∞Îä•:
 * 1. ÏßÑÎã® Í≤∞Í≥ºÎ•º HTMLÎ°ú Î≥ÄÌôò
 * 2. HTMLÏùÑ PDFÎ°ú ÏÉùÏÑ± (jsPDF + html2canvas)
 * 3. PDFÎ•º base64Î°ú Ïù∏ÏΩîÎî©
 * 4. Google Apps ScriptÎ•º ÌÜµÌï¥ PDF Ï≤®Î∂Ä Ïù¥Î©îÏùº Î∞úÏÜ°
 */

import { appConfig } from '../config/env';

// üîß ÌÉÄÏûÖ Ï†ïÏùò
export interface DiagnosisReportData {
  companyName: string;
  contactName: string;
  contactEmail: string;
  contactPhone?: string;
  totalScore: number;
  overallGrade: string;
  industryType: string;
  employeeCount: string;
  categoryResults: Array<{
    categoryName: string;
    score100: number;
    currentScore: number;
  }>;
  strengths: string[];
  weaknesses: string[];
  opportunities: string[];
  actionPlan: string[];
  recommendedServices: string[];
  consultant: {
    name: string;
    phone: string;
    email: string;
  };
  summaryReport?: string;
  diagnosisDate: string;
}

export interface PdfEmailResult {
  success: boolean;
  message: string;
  data?: any;
  error?: string;
  pdfBase64?: string; // PDF base64 Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
}

/**
 * üé® PDF ÏßÑÎã®Î≥¥Í≥†ÏÑú HTML ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
 */
function generateDiagnosisReportHTML(data: DiagnosisReportData): string {
  const currentDate = new Date().toLocaleDateString('ko-KR');
  
  return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Î¨¥Î£åÏßÑÎã® Í≤∞Í≥ºÎ≥¥Í≥†ÏÑú - ${data.companyName}</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            line-height: 1.6;
            color: #333;
            background: #ffffff;
            font-size: 14px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 30px;
            background: white;
        }
        
        .header {
            text-align: center;
            border-bottom: 3px solid #4285f4;
            padding-bottom: 30px;
            margin-bottom: 40px;
        }
        
        .header h1 {
            color: #4285f4;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .header .subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 20px;
        }
        
        .company-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .company-info h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .company-info h2::before {
            content: "üè¢";
            margin-right: 8px;
            font-size: 20px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px;
        }
        
        .info-item {
            display: flex;
            align-items: center;
        }
        
        .info-item .label {
            font-weight: 500;
            color: #555;
            min-width: 80px;
            margin-right: 10px;
        }
        
        .info-item .value {
            color: #333;
            font-weight: 400;
        }
        
        .score-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .score-main {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .score-grade {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 15px;
        }
        
        .score-description {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .section {
            margin-bottom: 35px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
            display: flex;
            align-items: center;
        }
        
        .section-title::before {
            margin-right: 10px;
            font-size: 22px;
        }
        
        .category-results {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .category-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #4285f4;
        }
        
        .category-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .category-score {
            font-size: 24px;
            font-weight: 700;
            color: #4285f4;
        }
        
        .category-score span {
            font-size: 14px;
            color: #666;
            font-weight: 400;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .analysis-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        
        .analysis-card h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
        }
        
        .analysis-card h3::before {
            margin-right: 8px;
            font-size: 18px;
        }
        
        .analysis-card.strengths h3::before { content: "üí™"; }
        .analysis-card.weaknesses h3::before { content: "‚ö†Ô∏è"; }
        .analysis-card.opportunities h3::before { content: "üöÄ"; }
        
        .analysis-list {
            list-style: none;
        }
        
        .analysis-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f1f3f4;
            color: #555;
            font-size: 13px;
        }
        
        .analysis-list li:last-child {
            border-bottom: none;
        }
        
        .analysis-list li::before {
            content: "‚Ä¢";
            color: #4285f4;
            font-weight: bold;
            margin-right: 8px;
        }
        
        .action-plan {
            background: #e8f5e8;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        
        .action-plan h3 {
            color: #28a745;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .action-plan h3::before {
            content: "üìã";
            margin-right: 10px;
            font-size: 20px;
        }
        
        .action-steps {
            list-style: none;
            counter-reset: step-counter;
        }
        
        .action-steps li {
            counter-increment: step-counter;
            margin-bottom: 12px;
            padding-left: 35px;
            position: relative;
            color: #333;
            font-size: 14px;
        }
        
        .action-steps li::before {
            content: counter(step-counter);
            position: absolute;
            left: 0;
            top: 0;
            background: #28a745;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        
        .services-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
            margin-bottom: 30px;
        }
        
        .services-section h3 {
            color: #856404;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .services-section h3::before {
            content: "‚≠ê";
            margin-right: 10px;
            font-size: 20px;
        }
        
        .services-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .service-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
            text-align: center;
            font-weight: 500;
            color: #333;
            font-size: 13px;
        }
        
        .consultant-info {
            background: #d1ecf1;
            padding: 25px;
            border-radius: 8px;
            border-left: 4px solid #17a2b8;
            margin-top: 30px;
        }
        
        .consultant-info h3 {
            color: #0c5460;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .consultant-info h3::before {
            content: "üë®‚Äçüíº";
            margin-right: 10px;
            font-size: 20px;
        }
        
        .consultant-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .consultant-item {
            display: flex;
            align-items: center;
            color: #0c5460;
            font-weight: 500;
        }
        
        .consultant-item::before {
            margin-right: 10px;
            font-size: 16px;
        }
        
        .consultant-item.name::before { content: "üë§"; }
        .consultant-item.phone::before { content: "üìû"; }
        .consultant-item.email::before { content: "üìß"; }
        
        .footer {
            margin-top: 40px;
            padding-top: 30px;
            border-top: 2px solid #e9ecef;
            text-align: center;
            color: #666;
            font-size: 12px;
        }
        
        .footer .brand {
            font-weight: 600;
            color: #4285f4;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .footer .disclaimer {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
            font-style: italic;
            color: #666;
        }
        
        @media print {
            body { font-size: 12px; }
            .container { padding: 20px; }
            .header h1 { font-size: 24px; }
            .score-main { font-size: 36px; }
            .section-title { font-size: 18px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI Î¨¥Î£åÏßÑÎã® Í≤∞Í≥ºÎ≥¥Í≥†ÏÑú</h1>
            <div class="subtitle">AICAMP AI ÍµêÏú°ÏÑºÌÑ∞ - Ï†ÑÎ¨∏ Í∏∞ÏóÖ ÏßÑÎã® ÏÑúÎπÑÏä§</div>
            <div style="color: #666; font-size: 14px;">ÏßÑÎã®Ïùº: ${data.diagnosisDate}</div>
        </div>

        <div class="company-info">
            <h2>Í∏∞ÏóÖ Ï†ïÎ≥¥</h2>
            <div class="info-grid">
                <div class="info-item">
                    <span class="label">ÌöåÏÇ¨Î™Ö:</span>
                    <span class="value">${data.companyName}</span>
                </div>
                <div class="info-item">
                    <span class="label">Îã¥ÎãπÏûê:</span>
                    <span class="value">${data.contactName}</span>
                </div>
                <div class="info-item">
                    <span class="label">ÏóÖÏ¢Ö:</span>
                    <span class="value">${data.industryType}</span>
                </div>
                <div class="info-item">
                    <span class="label">ÏßÅÏõêÏàò:</span>
                    <span class="value">${data.employeeCount}</span>
                </div>
                <div class="info-item">
                    <span class="label">Ïó∞ÎùΩÏ≤ò:</span>
                    <span class="value">${data.contactPhone || '-'}</span>
                </div>
                <div class="info-item">
                    <span class="label">Ïù¥Î©îÏùº:</span>
                    <span class="value">${data.contactEmail}</span>
                </div>
            </div>
        </div>

        <div class="score-section">
            <div class="score-main">${data.totalScore}Ï†ê</div>
            <div class="score-grade">${data.overallGrade}Îì±Í∏â</div>
            <div class="score-description">Ï¢ÖÌï© Í≤ΩÏòÅ ÏßÑÎã® Í≤∞Í≥º</div>
        </div>

        <div class="section">
            <h2 class="section-title" style="--emoji: 'üìä';">Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉÅÏÑ∏ Ï†êÏàò</h2>
            <div class="category-results">
                ${data.categoryResults.map(category => `
                    <div class="category-card">
                        <div class="category-name">${category.categoryName}</div>
                        <div class="category-score">${category.score100}<span>/100</span></div>
                    </div>
                `).join('')}
            </div>
        </div>

        <div class="section">
            <h2 class="section-title">üîç Ï¢ÖÌï© Î∂ÑÏÑù Í≤∞Í≥º</h2>
            <div class="analysis-grid">
                <div class="analysis-card strengths">
                    <h3>Í∞ïÏ†ê ÏòÅÏó≠</h3>
                    <ul class="analysis-list">
                        ${data.strengths.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                <div class="analysis-card weaknesses">
                    <h3>Í∞úÏÑ† ÏòÅÏó≠</h3>
                    <ul class="analysis-list">
                        ${data.weaknesses.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
                <div class="analysis-card opportunities">
                    <h3>Í∏∞Ìöå ÏöîÏÜå</h3>
                    <ul class="analysis-list">
                        ${data.opportunities.map(item => `<li>${item}</li>`).join('')}
                    </ul>
                </div>
            </div>
        </div>

        ${data.actionPlan.length > 0 ? `
        <div class="section">
            <div class="action-plan">
                <h3>ÎßûÏ∂§Ìòï Ïã§Ìñâ Í≥ÑÌöç</h3>
                <ol class="action-steps">
                    ${data.actionPlan.map(step => `<li>${step}</li>`).join('')}
                </ol>
            </div>
        </div>
        ` : ''}

        ${data.recommendedServices.length > 0 ? `
        <div class="section">
            <div class="services-section">
                <h3>Ï∂îÏ≤ú ÏÑúÎπÑÏä§</h3>
                <div class="services-list">
                    ${data.recommendedServices.map(service => `
                        <div class="service-item">${service}</div>
                    `).join('')}
                </div>
            </div>
        </div>
        ` : ''}

        ${data.summaryReport ? `
        <div class="section">
            <h2 class="section-title">üìù ÏÉÅÏÑ∏ Î∂ÑÏÑù Î¶¨Ìè¨Ìä∏</h2>
            <div style="background: #f8f9fa; padding: 25px; border-radius: 8px; line-height: 1.8; color: #333;">
                ${data.summaryReport.replace(/\n/g, '<br>')}
            </div>
        </div>
        ` : ''}

        <div class="consultant-info">
            <h3>Ï†ÑÎ¨∏Í∞Ä ÏÉÅÎã¥ Ï†ïÎ≥¥</h3>
            <div class="consultant-details">
                <div class="consultant-item name">${data.consultant.name}</div>
                <div class="consultant-item phone">${data.consultant.phone}</div>
                <div class="consultant-item email">${data.consultant.email}</div>
            </div>
            <div style="margin-top: 15px; color: #0c5460; font-size: 14px;">
                Îçî ÏÉÅÏÑ∏Ìïú ÏÉÅÎã¥ÏùÑ ÏõêÌïòÏãúÎ©¥ Ïñ∏Ï†úÎì†ÏßÄ Ïó∞ÎùΩÏ£ºÏÑ∏Ïöî. Í∏∞ÏóÖ ÎßûÏ∂§Ìòï ÏÜîÎ£®ÏÖòÏùÑ Ï†úÍ≥µÌï¥ÎìúÎ¶ΩÎãàÎã§.
            </div>
        </div>

        <div class="footer">
            <div class="brand">AICAMP AI ÍµêÏú°ÏÑºÌÑ∞</div>
            <div>Tel: ${data.consultant.phone} | Email: ${data.consultant.email}</div>
            <div style="margin-top: 10px;">¬© 2025 AICAMP. All rights reserved.</div>
            
            <div class="disclaimer">
                ‚ö†Ô∏è Î≥∏ Î≥¥Í≥†ÏÑúÎäî AI Í∏∞Î∞ò Î∂ÑÏÑù Í≤∞Í≥ºÏù¥Î©∞, Ï∞∏Í≥†Ïö©ÏúºÎ°ú ÌôúÏö©ÌïòÏãúÍ∏∞ Î∞îÎûçÎãàÎã§. 
                Îçî Ï†ïÌôïÌïú ÏßÑÎã®Í≥º ÎßûÏ∂§Ìòï ÏÜîÎ£®ÏÖòÏùÑ ÏúÑÌï¥ÏÑúÎäî Ï†ÑÎ¨∏Í∞Ä ÏÉÅÎã¥ÏùÑ Î∞õÏúºÏãúÍ∏∏ Í∂åÌï©ÎãàÎã§.
            </div>
        </div>
    </div>
</body>
</html>`;
}

/**
 * üìÑ HTMLÏùÑ PDFÎ°ú Î≥ÄÌôò (jsPDF + html2canvas ÏÇ¨Ïö©)
 */
async function convertHtmlToPdf(htmlContent: string, filename: string): Promise<string> {
  try {
    // Dynamic import for client-side only
    const [jsPDF, html2canvas] = await Promise.all([
      import('jspdf').then(module => module.jsPDF),
      import('html2canvas').then(module => module.default)
    ]);

    // ÏûÑÏãú DOM ÏöîÏÜå ÏÉùÏÑ±
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = htmlContent;
    tempDiv.style.position = 'absolute';
    tempDiv.style.left = '-9999px';
    tempDiv.style.top = '0';
    tempDiv.style.width = '800px';
    tempDiv.style.background = 'white';
    document.body.appendChild(tempDiv);

    try {
      // HTMLÏùÑ Ï∫îÎ≤ÑÏä§Î°ú Î≥ÄÌôò
      const canvas = await html2canvas(tempDiv, {
        scale: 2,
        useCORS: true,
        allowTaint: true,
        backgroundColor: '#ffffff',
        width: 800,
        height: tempDiv.scrollHeight
      });

      // PDF ÏÉùÏÑ±
      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'mm',
        format: 'a4'
      });

      const imgWidth = 210; // A4 width in mm
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      const pageHeight = 297; // A4 height in mm
      let heightLeft = imgHeight;
      let position = 0;

      // Ï≤´ ÌéòÏù¥ÏßÄ Ï∂îÍ∞Ä
      pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
      heightLeft -= pageHeight;

      // Ïó¨Îü¨ ÌéòÏù¥ÏßÄ Ï≤òÎ¶¨
      while (heightLeft >= 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      // PDFÎ•º base64Î°ú Î≥ÄÌôò
      const pdfBase64 = pdf.output('datauristring').split(',')[1];
      
      return pdfBase64;

    } finally {
      // ÏûÑÏãú DOM ÏöîÏÜå Ï†úÍ±∞
      document.body.removeChild(tempDiv);
    }

  } catch (error) {
    console.error('PDF Î≥ÄÌôò Ïò§Î•ò:', error);
    throw new Error(`PDF ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'}`);
  }
}

/**
 * üöÄ Google Apps ScriptÎ•º ÌÜµÌïú PDF Ï≤®Î∂Ä Ïù¥Î©îÏùº Î∞úÏÜ°
 */
async function sendPdfEmail(pdfBase64: string, reportData: DiagnosisReportData): Promise<PdfEmailResult> {
  try {
    const emailData = {
      action: 'sendDiagnosisPdfEmail',
      ÌèºÌÉÄÏûÖ: 'AI_ÏßÑÎã®Í≤∞Í≥º_PDFÎ∞úÏÜ°',
      
      // ÏàòÏã†Ïûê Ï†ïÎ≥¥
      to_email: reportData.contactEmail,
      to_name: reportData.contactName,
      company_name: reportData.companyName,
      
      // PDF Ï≤®Î∂ÄÌååÏùº
      pdf_attachment: pdfBase64,
      pdf_filename: `AIÏßÑÎã®Î≥¥Í≥†ÏÑú_${reportData.companyName}_${new Date().toISOString().split('T')[0]}.pdf`,
      
      // Ïù¥Î©îÏùº ÎÇ¥Ïö©
      diagnosis_date: reportData.diagnosisDate,
      total_score: reportData.totalScore,
      overall_grade: reportData.overallGrade,
      industry_type: reportData.industryType,
      
      // Ïª®ÏÑ§ÌÑ¥Ìä∏ Ï†ïÎ≥¥
      consultant_name: reportData.consultant.name,
      consultant_phone: reportData.consultant.phone,
      consultant_email: reportData.consultant.email,
      
      // Î©îÌÉÄÎç∞Ïù¥ÌÑ∞
      Ï†úÏ∂úÏùºÏãú: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' }),
      timestamp: Date.now()
    };

    console.log('üìß PDF Ï≤®Î∂Ä Ïù¥Î©îÏùº Î∞úÏÜ° ÏöîÏ≤≠:', {
      action: emailData.action,
      to_email: emailData.to_email,
      company_name: emailData.company_name,
      pdf_size: Math.round(pdfBase64.length / 1024) + 'KB'
    });

    // Google Apps Script ÏóîÎìúÌè¨Ïù∏Ìä∏Î°ú Ï†ÑÏÜ°
    const response = await fetch(appConfig.googleScriptUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
      },
      body: JSON.stringify(emailData),
      mode: 'cors'
    });

    if (!response.ok) {
      throw new Error(`Google Apps Script Ïò§Î•ò: ${response.status} ${response.statusText}`);
    }

    const result = await response.text();
    console.log('‚úÖ PDF Ï≤®Î∂Ä Ïù¥Î©îÏùº Î∞úÏÜ° ÏôÑÎ£å:', result);

    return {
      success: true,
      message: `AI ÏßÑÎã® Í≤∞Í≥ºÎ≥¥Í≥†ÏÑúÍ∞Ä ${reportData.contactEmail}Î°ú Î∞úÏÜ°ÎêòÏóàÏäµÎãàÎã§.`,
      data: { response: result }
    };

  } catch (error) {
    console.error('‚ùå PDF Ïù¥Î©îÏùº Î∞úÏÜ° Ïã§Ìå®:', error);
    return {
      success: false,
      message: 'PDF Ïù¥Î©îÏùº Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
      error: error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'
    };
  }
}

/**
 * üéØ Î©îÏù∏ Í∏∞Îä•: AI ÏßÑÎã® Í≤∞Í≥ºÎ•º PDFÎ°ú ÏÉùÏÑ±Ìï¥ÏÑú Ïù¥Î©îÏùº Î∞úÏÜ°
 */
/**
 * üìÑ PDF ÏÉùÏÑ± Î∞è base64 Ïù∏ÏΩîÎî© (Ïù¥Î©îÏùº Î∞úÏÜ° ÏóÜÏù¥)
 */
export async function generateDiagnosisPdfBase64(reportData: DiagnosisReportData): Promise<PdfEmailResult> {
  try {
    console.log('üìÑ AI ÏßÑÎã® Í≤∞Í≥º PDF ÏÉùÏÑ± ÏãúÏûë:', reportData.companyName);

    // 1. HTML ÌÖúÌîåÎ¶ø ÏÉùÏÑ±
    const htmlContent = generateDiagnosisReportHTML(reportData);
    console.log('‚úÖ 1Îã®Í≥Ñ: HTML ÌÖúÌîåÎ¶ø ÏÉùÏÑ± ÏôÑÎ£å');

    // 2. HTMLÏùÑ PDFÎ°ú Î≥ÄÌôò
    const pdfBase64 = await convertHtmlToPdf(htmlContent, `AIÏßÑÎã®Î≥¥Í≥†ÏÑú_${reportData.companyName}`);
    console.log('‚úÖ 2Îã®Í≥Ñ: PDF ÏÉùÏÑ± ÏôÑÎ£å (ÌÅ¨Í∏∞:', Math.round(pdfBase64.length / 1024), 'KB)');

    return {
      success: true,
      message: 'PDF ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.',
      pdfBase64: pdfBase64,
      data: {
        filename: `AIÏßÑÎã®Î≥¥Í≥†ÏÑú_${reportData.companyName}_${new Date().toISOString().split('T')[0]}.pdf`,
        size: Math.round(pdfBase64.length / 1024) + 'KB'
      }
    };

  } catch (error) {
    console.error('‚ùå PDF ÏÉùÏÑ± Ïã§Ìå®:', error);
    return {
      success: false,
      message: 'PDF ÏÉùÏÑ± Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
      error: error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'
    };
  }
}

/**
 * üìß PDF ÏÉùÏÑ± Î∞è Ïù¥Î©îÏùº Î∞úÏÜ° (Í∏∞Ï°¥ Ìï®Ïàò - Ìò∏ÌôòÏÑ± Ïú†ÏßÄ)
 */
export async function sendDiagnosisReportPdf(reportData: DiagnosisReportData): Promise<PdfEmailResult> {
  try {
    console.log('üöÄ AI ÏßÑÎã® Í≤∞Í≥º PDF Ïù¥Î©îÏùº Î∞úÏÜ° ÏãúÏûë:', reportData.companyName);

    // 1. PDF ÏÉùÏÑ±
    const pdfResult = await generateDiagnosisPdfBase64(reportData);
    
    if (!pdfResult.success || !pdfResult.pdfBase64) {
      return pdfResult;
    }

    console.log('‚úÖ PDF ÏÉùÏÑ± ÏôÑÎ£å, Ïù¥Î©îÏùº Î∞úÏÜ° Í±¥ÎÑàÎõ∞Í∏∞ (Google Apps Script ÏÇ¨Ïö©)');
    
    // PDF base64 Îç∞Ïù¥ÌÑ∞ÏôÄ Ìï®Íªò Î∞òÌôò (Ïã§Ï†ú Ïù¥Î©îÏùº Î∞úÏÜ°ÏùÄ Google Apps ScriptÏóêÏÑú Ï≤òÎ¶¨)
    return {
      success: true,
      message: 'PDF ÏÉùÏÑ±Ïù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§. Google Apps ScriptÎ°ú Ïù¥Î©îÏùºÏùÑ Î∞úÏÜ°ÌïòÏÑ∏Ïöî.',
      pdfBase64: pdfResult.pdfBase64,
      data: pdfResult.data
    };

  } catch (error) {
    console.error('‚ùå PDF Ïù¥Î©îÏùº Î∞úÏÜ° ÌîÑÎ°úÏÑ∏Ïä§ Ïã§Ìå®:', error);
    return {
      success: false,
      message: 'PDF ÏÉùÏÑ± Î∞è Ïù¥Î©îÏùº Î∞úÏÜ° Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
      error: error instanceof Error ? error.message : 'Ïïå Ïàò ÏóÜÎäî Ïò§Î•ò'
    };
  }
}

/**
 * üîç Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤ΩÏóêÏÑú PDF ÎØ∏Î¶¨Î≥¥Í∏∞ (Í∞úÎ∞ú/ÌÖåÏä§Ìä∏Ïö©)
 */
export function previewDiagnosisReportPdf(reportData: DiagnosisReportData): void {
  const htmlContent = generateDiagnosisReportHTML(reportData);
  
  const previewWindow = window.open('', '_blank');
  if (previewWindow) {
    previewWindow.document.write(htmlContent);
    previewWindow.document.close();
  } else {
    alert('ÌåùÏóÖÏù¥ Ï∞®Îã®ÎêòÏóàÏäµÎãàÎã§. ÌåùÏóÖÏùÑ ÌóàÏö©Ìï¥Ï£ºÏÑ∏Ïöî.');
  }
}

/**
 * üìä ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏
 */
export function getPdfEmailServiceStatus() {
  return {
    service: 'PDF Email Service',
    features: [
      'HTML ‚Üí PDF Î≥ÄÌôò (jsPDF + html2canvas)',
      'Base64 Ïù∏ÏΩîÎî©',
      'Google Apps Script Ï≤®Î∂ÄÌååÏùº Ïù¥Î©îÏùº',
      'ÌïúÍ∏Ä Ìè∞Ìä∏ ÏßÄÏõê',
      'Î∞òÏùëÌòï PDF Î†àÏù¥ÏïÑÏõÉ'
    ],
    requirements: [
      'jsPDF ÎùºÏù¥Î∏åÎü¨Î¶¨',
      'html2canvas ÎùºÏù¥Î∏åÎü¨Î¶¨', 
      'Google Apps Script ÏÑ§Ï†ï',
      'Î∏åÎùºÏö∞Ï†Ä ÌôòÍ≤Ω (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ ÏÇ¨Ïù¥Îìú Ïã§Ìñâ)'
    ],
    status: {
      hasGoogleScript: !!appConfig.googleScriptUrl,
      isClientSide: typeof window !== 'undefined',
      timestamp: new Date().toISOString()
    }
  };
} 